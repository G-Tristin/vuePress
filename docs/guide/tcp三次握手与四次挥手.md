# tcp链接的三次握手和四次挥手

## tcp是面向连接的无状态的协议。为了连接的可靠性，每次连接的建立都需要三次握手

### 三次握手的目的

- 同步连接双方的序列号和确认号
- 交换TCP窗口大小信息

### 为什么要3次?而不是2次?
为了防止已失效的连接请求报文段突然又传送到了服务端，因而发生错误。

**已失效的请求报文段**的产生在下面的这种情况下:

客户端发送一个连接请求报文，因为某些原因滞留了在这个请求报文失效后的某段时候到达服务器。服务器接收到这个连接请求之后，向客户端发送确认报文，同意建立连接。然而客户端会忽视这个确认报文，也不会向服务器发送数据。但是服务器以为新的连接已经建立，一直等待客户端发来数据。这样服务器的许多资源就白白浪费了。三次握手的主要目的防止服务端一直等待消耗资源。

### 三次握手的过程
1. 第一次握手:客户端A将标志位SYN置为1，随机生成一个值为seq=j(j的取值范围在1234567之内)的数据包到服务器，客户端A进入SYN_SENT状态，等待服务端B确认。
2. 第二次握手:服务端B由标志位SYN=1知道客户端A请求建立连接，服务端B将标志位SYN和ACK都置为1，ack=j+1,随机产生一个值seq=K,并将该数据包发送给客户端A以确认连接请求，服务端B进入SYN_RCVD状态。
3. 第三次握手:客户端A收到确认后，检查ack是否为j+1,ACK是否为1，如果正确则将标志位ACK置为1，ack=K+1,并将改数据包发送给服务端B，服务端B检查ack是否为K+1，ACK是否为1，如果正确则连接建立成功，客户端A和服务端B进入ESTABLISHED状态，完成三次握手，随后客户端A与服务端B之间可以开始传输数据了。

## 四次挥手


- 客户端：“兄弟，我这边没数据要传了，咱关闭连接吧。”
- 服务端：“收到，我看看我这边有木有数据了。”
- 服务端：“兄弟，我这边也没数据要传你了，咱可以关闭连接了。”
- 客户端：“好嘞。”

四次挥手
- 客户端发送关闭连接的请求，仅仅表示自己不再发送数据但是还能接收数据
- 服务端确认你可以不发数据了，不过还要确认是否还有数据需要发送给客户端
- 等服务端确认完自己没有数据要发送后，通知客户端没有数据发送，可以关闭连接
- 确认服务端状态，关闭连接